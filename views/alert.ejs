<header class="w3-container w3-hide-small hero-bg w3-center w3-margin-32 w3-padding-32" style="padding-top: 0px!important;">
    <div class="w3-container hero-bg w3-cell-row">
        <div class="w3-cell onhover-bg w3-padding-16">Mon exploitation</div>
        <div class="w3-cell onhover-bg w3-padding-16">Espace collaboratif</div>
        <div class="w3-cell onhover-bg w3-padding-16">Alertes</div>
        <div class="w3-cell onhover-bg w3-padding-16"><%= locals.mail || '' %></div>
    </div>
    <h1 class="w3-jumbo"><b>Espace collaboratif</b></h1>
    <h2 class="w3-xlarge">Moyenne en Champagne : <strong><%= locals.moyrend %></strong> Kg/Ha</h2>
    </header>
    <header class="w3-container w3-hide-medium w3-hide-large hero-bg w3-center w3-padding-32">
    <h1 class="w3-xxlarge"><b>Espace collaboratif</b></h1>
    <h2 class="w3-large">Moyenne en Champagne : <strong><%= locals.moyrend %></strong> Kg/Ha</h2>
    </header>
    
    <div id='map' style='width: calc(100vw - 32px); height: 400px; margin: 16px;'></div>
                    
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.48.0/mapbox-gl.css' rel='stylesheet' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.48.0/mapbox-gl.js'></script>
    <script>
        let receivedJSON = []
        const req = new XMLHttpRequest();
        req.onreadystatechange = function(event) {
            // XMLHttpRequest.DONE === 4
            if (this.readyState === XMLHttpRequest.DONE) {
                if (this.status === 200) {
                    console.log("Réponse reçue: %s", this.responseText);
                } else {
                    alert("Erreur dans la recup AJAX")
                }
            }
        };

        req.open('GET', '/socialData', true);
        req.send(null);

        let Increment = 0;
    
        mapboxgl.accessToken = 'pk.eyJ1IjoibG91bG91MTIzNTQ2IiwiYSI6ImNqbGl6MHptcjA2MDczcHIwMTU2ajIxYzIifQ.ju33SqTTHGHZdunbEx7VKg';
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/satellite-streets-v10',
            /*center: [
            <%= locals.parcel ? locals.parcel.lng : 0.0001 %>,
            <%= locals.parcel ? locals.parcel.lat : 0.0002 %>
            ],*/
            center: [
            2,
            3
            ],
            zoom: 5
        });
    
        map.on('load', function () {
            map.loadImage('https://raw.githubusercontent.com/NerOcrO/vigne/master/assets/map_marker_r.png', function(error, image) {
                if (error) throw error;
                map.addImage('farmR', image)
            });
            map.loadImage('https://raw.githubusercontent.com/NerOcrO/vigne/master/assets/map_marker_g.png', function(error, image) {
                if (error) throw error;
                map.addImage('farmG', image)
            });
            map.loadImage('https://raw.githubusercontent.com/NerOcrO/vigne/master/assets/map_marker_y.png', function(error, image) {
                if (error) throw error;
                map.addImage('farmY', image)
            });
            
            setTimeout(() => {
                map.addLayer({
                    "id": "farmsR",
                    "type": "symbol",
                    "source": {
                        "type": "geojson",
                        "data": {
                            "type": "FeatureCollection",
                            "features": [
                                {
                                    "type": "Feature",
                                    "properties": {},
                                    "geometry": {
                                        "type": "Point",
                                        /*"coordinates": [
                                            <%= locals.parcel ? locals.parcel.lng : 0.0001 %>,
                                            <%= locals.parcel ? locals.parcel.lat : 0.0002 %>
                                        ]*/
                                        "coordinates": [
                                            1,
                                            2
                                        ]
                                    }
                                },{
                                    "type": "Feature",
                                    "properties": {},
                                    "geometry": {
                                        "type": "Point",
                                        /*"coordinates": [
                                            <%= locals.parcel ? locals.parcel.lng : 0.0001 %>,
                                            <%= locals.parcel ? locals.parcel.lat : 0.0002 %>
                                        ]*/
                                        "coordinates": [
                                            2,
                                            2
                                        ]
                                    }
                                }
                            ]
                        }
                    },
                    "layout": {
                        "icon-image": "farmR",
                        "icon-size": 0.05,
                        "icon-allow-overlap": true
                    }
                });
                map.addLayer({
                    "id": "farmsY",
                    "type": "symbol",
                    "source": {
                        "type": "geojson",
                        "data": {
                            "type": "FeatureCollection",
                            "features": [
                                {
                                    "type": "Feature",
                                    "properties": {},
                                    "geometry": {
                                        "type": "Point",
                                        /*"coordinates": [
                                            <%= locals.parcel ? locals.parcel.lng : 0.0001 %>,
                                            <%= locals.parcel ? locals.parcel.lat : 0.0002 %>
                                        ]*/
                                        "coordinates": [
                                            2,
                                            3
                                        ]
                                    }
                                }
                            ]
                        }
                    },
                    "layout": {
                        "icon-image": "farmY",
                        "icon-size": 0.05,
                        "icon-allow-overlap": true
                    }
                });
                map.addLayer({
                    "id": "farmsG",
                    "type": "symbol",
                    "source": {
                        "type": "geojson",
                        "data": {
                            "type": "FeatureCollection",
                            "features": [
                                {
                                    "type": "Feature",
                                    "properties": {},
                                    "geometry": {
                                        "type": "Point",
                                        /*"coordinates": [
                                            <%= locals.parcel ? locals.parcel.lng : 0.0001 %>,
                                            <%= locals.parcel ? locals.parcel.lat : 0.0002 %>
                                        ]*/
                                        "coordinates": [
                                            3,
                                            4
                                        ]
                                    }
                                }
                            ]
                        }
                    },
                    "layout": {
                        "icon-image": "farmG",
                        "icon-size": 0.05,
                        "icon-allow-overlap": true
                    }
                });
                map.resize();
                map.setZoom(6)
            }, 500);
        });
        map.on("click", function(e) {
            let res = {
                lng: 0,
                lat: 0,
                rend: 0,
                dist: 2
            }
            receivedJSON.forEach(element => {
                if(Math.abs(e.lngLat.lng - element.lng) + Math.abs(e.lngLat.lat - element.lat) < res.dist){
                    res = {
                        lng: element.lng,
                        lat: element.lat,
                        rend: element.rend,
                        dist: Math.abs(e.lngLat.lng - element.lng) + Math.abs(e.lngLat.lat - element.lat)
                    }
                }
            });
            if(res.dist < 2){
                document.getElementById("modal_rend").innerHTML = res.rend
                document.getElementById("mymodal").style.display = 'block'
            }
        });
    </script>